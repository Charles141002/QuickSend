<!DOCTYPE html>
<html>
<head>
    <title>Paiement de Crédits</title>
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
    <h1>Paiement de Crédits</h1>
    <form id="payment-form">
        <div id="card-element">
            </div>
        <button id="submit">Payer</button>
        <div id="payment-message" class="hidden"></div>
    </form>

    <script>
        const stripe = Stripe('pk_test_51QuiCOLaNGDU6bg8H7OJf3qWFes0QNnr8J9XpYxZD8eZnjoDIOMKhE2zybQJgjT61TX4JqetNDjsQM5FR3Dx8CP100Otp3TonE'); // Remplacez par votre clé publique
        const elements = stripe.elements();
        const cardElement = elements.create('card');
        cardElement.mount('#card-element');

        const form = document.getElementById('payment-form');
        const paymentMessage = document.getElementById('payment-message');

        form.addEventListener('submit', async (event) => {
            console.log("submit");
            event.preventDefault();

            const amount = 500; // Montant en centimes (à adapter si besoin)

            const response = await fetch('http://127.0.0.1:8000/api/credits/create-payment-intent?amount=' + amount, { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJjaGFybGVzcGVsb25nQGdtYWlsLmNvbSIsImV4cCI6MTc0MDEyODU4Mn0.dWobLlMncDaDFusesAG0NpZcjGbNdkfAtS06xeblIVs'
                }
            });

            console.log("STATUT :", response.status);

            console.log(response);

            const { clientSecret } = await response.json();

            console.log("Client Secret reçu :", clientSecret);


            const { error, paymentIntent } = await stripe.confirmCardPayment(
                clientSecret, {
                    payment_method: {
                        card: cardElement,
                    }
                }
            );

            if (error) {
                paymentMessage.classList.remove('hidden');
                paymentMessage.textContent = `Error: ${error.message}`;
            } else if (paymentIntent && paymentIntent.status === 'succeeded') {
                paymentMessage.classList.remove('hidden');
                paymentMessage.textContent = 'Succès du paiement !';
                // Ici, vous pourriez rediriger l'utilisateur ou faire d'autres actions après paiement réussi
                console.log('PaymentIntent:', paymentIntent); // Pour voir les détails dans la console
            }
        });
    </script>
</body>
</html>